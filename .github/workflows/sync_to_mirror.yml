name: Sync sync-origin to sync-mirror

on:
  push:
    branches:
      - main

jobs:
  sync:
    if: github.repository == 'penguinspizza/sync-origin'  # この条件でsync-originに限定

    runs-on: ubuntu-latest

    steps:
      # Checkout sync-origin (Current Repo)
      - name: Checkout sync-origin
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          ref: main

      # Clone sync-mirror using secrets.PAT (Personal Access Token)
      - name: Clone sync-mirror
        run: |
          git clone https://penguinspizza:${{ secrets.PAT }}@github.com/penguinspizza/sync-mirror.git
          cd sync-mirror
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      # Remove all files in sync-mirror
      - name: Remove all files in sync-mirror
        run: |
          cd sync-mirror
          rm -rf *

      # Copy files from sync-origin to sync-mirror, excluding the sync-mirror directory itself
      - name: Copy files from sync-origin to sync-mirror
        run: |
          rsync -a --exclude 'sync-mirror' ./ sync-mirror/

      # Commit and Push changes to sync-mirror using secrets.PAT
      - name: Commit and Push changes to sync-mirror
        run: |
          cd sync-mirror
          git add .
          git commit -m "Sync from sync-origin"
          git push https://penguinspizza:${{ secrets.PAT }}@github.com/penguinspizza/sync-mirror.git
